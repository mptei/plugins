{% extends "base_plugin.html" %}

{% set logo_frame = false %}

<!-- set update_interval to a value > 0 (in milliseconds) to enable periodic data updates -->
{% set update_interval = 5000 %}

<!--
	Additional script tag for plugin specific javascript code go into this block
-->
{% block pluginscripts %}
<script type="text/javascript">
	var inAjaxError = false;
	$(document).ajaxError(function(event, jqxhr, settings, thrownError) {
		shngInsertText('errorModalLabel', 'Error');
		shngInsertText('errorModalBody', jqxhr.responseText);
		$("#errorModal").modal("show");
		inAjaxError = true;
	});
	$(document).ready( function () {

		// handler for login
		$("#login_pressed").submit(function(e) {

			// prevent default HTML actions
			e.preventDefault();

			$("#loginModal").modal("hide");
			// Send a login request
			$.post('submit', {cmd: JSON.stringify({login:{user:$("#txtUser").val(),pass:$("#txtPwd").val(),store:$("#store_2_config").is(":checked")}})}, function(data) {
				handleUpdatedDataUnpacked(data);
			});
			return false ;
		});

		// handler for logout
		$("#logout_pressed").click(function(e) {

			// prevent default HTML actions
			e.preventDefault();

			$("#logoutModal").modal("hide");
			// Send a logout request
			$.post('submit', {cmd: JSON.stringify({logout:true})}, function(data) {
				handleUpdatedDataUnpacked(data);
			});
			return false ;
		});

		shngGetUpdatedData();
	});

	function handleUpdatedData(response, dataSet=null) {
		if (dataSet === 'devices_info' || dataSet === null) {
			var objResponse = JSON.parse(response);
			handleUpdatedDataUnpacked(objResponse, dataSet)
		}
	}

	var lastLoginState = undefined;
	var lastCloudOutage = undefined;
	var maxtime = 0
	function handleUpdatedDataUnpacked(objResponse, dataSet=null) {
		if (dataSet === 'devices_info' || dataSet === null) {
			myProto = document.getElementById(dataSet);
			if ('account' in objResponse) {
				var account = objResponse['account'];
				var loggedIn = account['loggedIn'];
				if (lastLoginState == undefined || lastLoginState != loggedIn) {
					$("#login_button").prop('disabled', loggedIn);
					$("#logout_button").prop('disabled', !loggedIn);
					if (!loggedIn) {
						// switch to login tab
						$('.nav-tabs a:last').tab('show')
						$("#nologin-alert").show();
					} else {
						// switch to items tab
						$('.nav-tabs a:first').tab('show');
						$("#nologin-alert").hide();
					}
					lastLoginState = loggedIn;
				}
			}
			if ('cloud' in objResponse) {
				var cloud = objResponse['cloud'];
				var indicator = cloud['indicator'];
				$('#cloudalert_descr').text(cloud['description']);
				var cloudOutage = indicator != 'none';
				if (lastCloudOutage != cloudOutage) {
					lastCloudOutage = cloudOutage;
					if (cloudOutage) {
						$('.nav-tabs a:last').tab('show')
						$("#cloud-alert").show();
						if (indicator == 'major') {
							$("#cloud-alert").addClass('alert-danger');
						} else {
							$("#cloud-alert").removeClass('alert-danger');
						}
					} else {
						$("#cloud-alert").hide();
					}
				}
			}
			if ('chargers' in objResponse) {
				var chargers = objResponse['chargers'];
				var tbody = $('#charger_table').find('tbody');
				tbody.empty();
				$.each(chargers, function(k,v) {
					var newRow = "<tr id='" + k + "_charger" + "'><td>" 
							+ v['id'] + "</td><td>" 
							+ v['name'] + "</td><td>" 
							+ (v['firm'] || "-") + "</td><td>" 
							+ (v['maxa'] || "-") + "</td><td>" 
							+ (v['site'] || "-") + "</td><td>" 
							+ (v['maxac'] || "-") + "</td></tr>";
					tbody.append(newRow);
				});
			}
			if ('signalr' in objResponse) {
				var updates = objResponse['signalr'];
				var tbody = $('#signalr_table').find('tbody');
				$.each(updates, function(k,v) {
					var time = v['time'];
					if (time > maxtime) {
						var newRow = "<tr id='" + k + "_update" + "'><td>" + new Date(v['time']).toLocaleString() + "</td><td>" + v['id'] + "</td><td>" + v['data_type'] + "</td><td>" + v['data_id'] + "</td><td>" + v['value'] + "</td></tr>";
						tbody.prepend(newRow);
						maxtime = time;
					}
				});
			}
			if ('items' in objResponse) {
				var updates = objResponse['items'];
				$.each(updates, function(k,v) {
					var col = $('#'+v['idx']+'_clickip').find("td:eq(2)");
					col.text(v['value']);
				});
			}
			if ('error' in objResponse && objResponse['error']) {
				shngInsertText('errorModalLabel', objResponse['title']);
				shngInsertText('errorModalBody', objResponse['text']);
				$("#errorModal").modal("show");
			} else if (inAjaxError) {
				inAjaxError = false;
				$("#errorModal").modal("hide");
			}
		}
	}

</script>
{% endblock pluginscripts %}


{% block headtable %}
<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<td class="py-1"><strong>{{_('Easee User')}}</strong></td>
			<td class="py-1">{% if easee_user == undeffined %}-{% else %}{{ easee_user }}{% endif %}</td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>{{_('Query cycle (cloud)')}}</strong></td>
			<td class="py-1">{{cloud_cycle}}</td>
			<td class="py-1" width="10px"></td>
		</tr>
	</tbody>
</table>
{% endblock headtable %}


<!--
	Additional buttons for the web interface (if any are needed) - displayed below the headtable-section
-->
{% block buttons %}
<!-- Modal -->
{% endblock %}

<!--
	Define the number of tabs for the body of the web interface (1 - 3)
-->
{% set tabcount = 4 %}


<!--
	Set the tab that will be visible on start, if another tab that 1 is wanted (1 - 3)
-->
{% set start_tab = 4 %}

<!--
	Content block for the first tab of the Webinterface
-->
{% set tab1title = "<strong>" ~ " Items</strong> (" ~ item_count ~ ")" %}
{% block bodytab1 %}
	{% if item_count > 0 %}
		<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
			<div class="col-sm-12">

				<form action="" method="post">
				<table class="table table-striped table-hover pluginList">
					<thead>
						<tr class="shng_heading">
							<th class="py-1">{{ _('Item') }}</th>
							<th class="py-1">{{ _('Type') }}</th>
							<th class="py-1">{{ _('Value') }}</th>
							<th class="py-1">{{ _('Easee type') }}</th>
							<th class="py-1">{{ _('Easee id') }}</th>
							<th class="py-1">{{ _('Easee function') }}</th>
						<th class="py-1" width="100px"></th>
						</tr>
					</thead>
					<tbody>
						{% for i in items %}
							<tr id="{{ loop.index }}_clickip" style="cursor: pointer;">
								<td class="py-1">{{ i }}</td>
								<td class="py-1">{{ items[i].item.property.type }}</td>
								<td class="py-1">{{ items[i].item() }}</td>
								<td class="py-1">{{ items[i].type }}</td>
								<td class="py-1">{{ items[i].id }}</td>
								<td class="py-1">{{ items[i].function }}</td>
								<td class="py-1"></td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				</form>
			</div>
		</div>
	{% endif %}
{% endblock bodytab1 %}


<!--
	Content block for the second tab of the Webinterface
	If wanted, a title for the tab can be defined as:
		{ % set tab2title = "<strong>" ~ p.get_shortname() ~ " Geräte</strong>" % }

	It has to be defined before (and outside) the block bodytab2
-->
{% set tab2title = "<strong>" ~ _('Chargers') ~ "</strong>" %}
{% block bodytab2 %}
	<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
		<div class="col-sm-12">

			<form action="" method="post">
			<table id="charger_table" class="table table-striped table-hover pluginList">
				<thead>
					<tr class="shng_heading">
						<th class="py-1">{{ _('Id') }}</th>
						<th class="py-1">{{ _('Name') }}</th>
						<th class="py-1">{{ _('Firmware') }}</th>
						<th class="py-1">{{ _('Max Current') }}</th>
						<th class="py-1">{{ _('Site') }}</th>
						<th class="py-1">{{ _('Circuit Rated Current') }}</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			</form>
		</div>
	</div>

{% endblock bodytab2 %}

<!--
	Content block for the second tab of the Webinterface
	If wanted, a title for the tab can be defined as:
		{ % set tab3title = "<strong>" ~ p.get_shortname() ~ " Geräte</strong>" % }

	It has to be defined before (and outside) the block bodytab3
-->
{% set tab3title = "<strong>" ~ _('SignalR') ~ "</strong>" %}
{% block bodytab3 %}
	<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
		<div class="col-sm-12">
			<table id="signalr_table" class="table table-striped table-hover pluginList">
				<thead>
					<tr class="shng_heading">
						<th class="py-1">{{ _('Timestamp') }}</th>
						<th class="py-1">{{ _('ID') }}</th>
						<th class="py-1">{{ _('Datatype') }}</th>
						<th class="py-1">{{ _('Type') }}</th>
						<th class="py-1">{{ _('Value') }}</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>

{% endblock bodytab3 %}

<!--
	Content block for the fourth tab of the Webinterface
	If wanted, a title for the tab can be defined as:
		{ % set tab4title = "<strong>" ~ p.get_shortname() ~ " Bridges</strong>" % }

	It has to be defined before (and outside) the block bodytab4
-->
{% set tab4title = "<strong>" ~ _('Account') ~ "</strong>" %}
{% block bodytab4 %}
	<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
		<div id="nologin-alert" class="alert alert-warning fade show" role="alert" style="display:none">
			<h4 class="alert-heading">{{ _('Not logged in into easee account.') }}</h4>
			<div>{{ _('On start please wait for login. Else press login button and log in.') }}</div>
		</div>
		<div id="cloud-alert" class="alert alert-warning fade show" role="alert" style="display:none">
			<h4 class="alert-heading">{{ _('Cloud service outage.') }}</h4>
			<div id='cloudalert_descr'></div>
			<div>{{ _('Please check Easee cloud.') }}</div>
		</div>
		<button id="login_button" type="button" class="btn btn-shng btn-sm" data-toggle="modal" data-target="#loginModal" disabled="disabled" >
			{{ _('Login') }}
		</button>
		<button id="logout_button" type="button" class="btn btn-shng btn-sm" data-toggle="modal" data-target="#logoutModal" disabled="disabled">
			{{ _('Login') }}
		</button>
		
		<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="loginLabel">{{ _('Easee credentials:') }}</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="login_pressed">
							<div class="form-group">
								<label for="exampleInputEmail1" hidden>{{ _('User') }}</label>
								<input type="user" class="form-control" id="txtUser" aria-describedby="emailHelp" placeholder="{{ _('Easee User') }}">
							</div>
							<div class="form-group">
								<label for="exampleInputPassword1" hidden>{{ _('Password') }}</label>
								<input type="password" class="form-control" id="txtPwd" placeholder="{{ _('Password') }}">
							</div>
								<div class="form-check">
								<input type="checkbox" class="form-check-input" id="store_2_config">
								<label class="form-check-label" for="store_2_config">{{ _('Store to Config') }}</label>
							</div>
							<button type="submit" class="btn btn-primary">{{ _('Login') }}</button>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="logoutLabel">{{ _('Logout from Easee account?') }}</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<button id="logout_pressed" type="submit" class="btn btn-primary">{{ _('Logout') }}</button>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _('Close') }}</button>
					</div>
				</div>
			</div>
		</div>
	</div>

{% endblock bodytab4 %}

{% block body %}
{{ super() }}
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="errorModalLabel"></h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body" id="errorModalBody">
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _('Close') }}</button>
			</div>
		</div>
	</div>
</div>
{% endblock body %}
